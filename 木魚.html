<script>
  new Vue({
    el: "#app",
    data: {
      count: 0,
      isClicked: false,
      volume: 0.5,
      showCrit: false,
      showSutra: false,
      currentSutra: "",
      nickname: "",
      leaderboard: [],
      sutras: [
        "諸行無常，是生滅法。",
        "一切有為法，如夢幻泡影。",
        "念佛一聲，罪滅河沙。",
        "若人欲了知，三世一切佛，應觀法界性，一切唯心造。",
        "萬法皆空，因果不空。",
        "色即是空，空即是色。",
        "心淨則國土淨。",
        "無所住而生其心。",
        "煩惱即菩提，生死即涅槃。",
        "福慧雙修，方得究竟涅槃。"
      ]
    },
    computed: {
      topLeaderboard() {
        return this.leaderboard.slice(0, 5);
      }
    },
    mounted() {
      this.fetchLeaderboard();
    },
    methods: {
      hit() {
        let isCrit = Math.random() < 0.1;
        let gain = isCrit ? 10 : 1;
        this.count += gain;

        this.isClicked = true;
        this.showCrit = isCrit;

        const audio = this.$refs.audio;
        audio.volume = this.volume;
        audio.currentTime = 0;
        audio.play();

        const index = Math.floor(Math.random() * this.sutras.length);
        this.currentSutra = this.sutras[index];
        this.showSutra = true;

        setTimeout(() => {
          this.isClicked = false;
          this.showCrit = false;
        }, 500);

        setTimeout(() => {
          this.showSutra = false;
        }, 5000);
      },
      reset() {
        this.count = 0;
      },
      submitScore() {
        if (!this.nickname.trim()) {
          alert("請輸入暱稱！");
          return;
        }

        fetch("https://script.google.com/macros/s/AKfycby2mwwXEmefEZ5SAbCCrWDKHVxtS5XsGrx25yP5wYHeHQnNx6P1IWieLLeH8OmkU--QiA/exec", {
          method: "POST",
          body: JSON.stringify({
            name: this.nickname.trim(),
            score: this.count
          }),
          headers: {
            "Content-Type": "application/json"
          }
        })
        .then(() => {
          alert("✅ 已成功提交到雲端排行榜！");
          this.count = 0;
          this.fetchLeaderboard();
        })
        .catch(err => {
          alert("❌ 提交失敗：" + err);
        });
      },
      fetchLeaderboard() {
        fetch("https://script.google.com/macros/s/AKfycby2mwwXEmefEZ5SAbCCrWDKHVxtS5XsGrx25yP5wYHeHQnNx6P1IWieLLeH8OmkU--QiA/exec")
          .then(res => res.json())
          .then(data => {
            this.leaderboard = data.sort((a, b) => b.score - a.score);
          })
          .catch(() => {
            console.warn("⚠️ 無法載入雲端排行榜");
          });
      }
    }
  });
</script>
